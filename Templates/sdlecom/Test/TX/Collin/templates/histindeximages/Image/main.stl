<#macro getUserRole(request)>
    <#if pageStyleUtil.isUserInRole('COLLIN_OFFICIAL_1', request)>
		<#assign useraccesscode = 'COLLIN_OFFICIAL_1' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_OFFICIAL_5', request)>
		<#assign useraccesscode = 'COLLIN_OFFICIAL_5' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_OFFICIAL_10', request)>
		<#assign useraccesscode = 'COLLIN_OFFICIAL_10' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_OFFICIAL_25', request)>
		<#assign useraccesscode = 'COLLIN_OFFICIAL_25' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_OFFICIAL_DISC_1', request)>
		<#assign useraccesscode = 'COLLIN_OFFICIAL_DISC_1' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_OFFICIAL_DISC_5', request)>
		<#assign useraccesscode = 'COLLIN_OFFICIAL_DISC_5' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_OFFICIAL_DISC_10', request)>
		<#assign useraccesscode = 'COLLIN_OFFICIAL_DISC_10' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_OFFICIAL_DISC_25', request)>
		<#assign useraccesscode = 'COLLIN_OFFICIAL_DISC_25' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_UNOFFICIAL_1', request)>
		<#assign useraccesscode = 'COLLIN_UNOFFICIAL_1' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_UNOFFICIAL_5', request)>
		<#assign useraccesscode = 'COLLIN_UNOFFICIAL_5' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_UNOFFICIAL_10', request)>
		<#assign useraccesscode = 'COLLIN_UNOFFICIAL_10' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_UNOFFICIAL_25', request)>
		<#assign useraccesscode = 'COLLIN_UNOFFICIAL_25' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_UNOFFICIAL_DISC_1', request)>
		<#assign useraccesscode = 'COLLIN_UNOFFICIAL_DISC_1' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_UNOFFICIAL_DISC_5', request)>
		<#assign useraccesscode = 'COLLIN_UNOFFICIAL_DISC_5' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_UNOFFICIAL_DISC_10', request)>
		<#assign useraccesscode = 'COLLIN_UNOFFICIAL_DISC_10' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_UNOFFICIAL_DISC_25', request)>
		<#assign useraccesscode = 'COLLIN_UNOFFICIAL_DISC_25' >
    <#elseif pageStyleUtil.isUserInRole('COLLIN_PERPAGE_ACCESS', request)>
		<#assign useraccesscode = 'COLLIN_PERPAGE_ACCESS' >
</#if>
</#macro>

<#-- ADD GOOGLE ANALYTICS -->
<#include "/templates/googleAnalytics-Collin.stl">

<#if request.getServletContext().getInitParameter("isSecurityEnabled") == "false" || (pageStyleUtil.isUserInRoleGroup('ALL_ROLE', request))>
<#assign isDownload = request.getParameter("isDownload") >
<#assign downloadDocument = request.getParameter("downloadDocument") >
	<#if searchResult.docs?has_content>
		<#foreach doc in searchResult.docs>
			<#assign imagelocation = "\\\\" + doc.get("Server")?trim + "\\" +  doc.get("Path")?trim + "\\" + doc.get("Booktype")?trim + "\\" + doc.get("BookName")?trim + "\\" + doc.get("IndexName")?trim + "\\" + doc.get("Image")?trim>
			<#if request.getServletContext().getInitParameter("isSecurityEnabled") == "false" || (pageStyleUtil.isUserInRoleGroup('OFFICIAL_ROLE', request))>
			<#assign baos = new("java.io.ByteArrayOutputStream")>
				<#assign converter = new("com.fdt.common.util.TIFFToPDFConverter")>
				<#if (converter.convert(imagelocation + ".burned", "", 159,159,159,90,0,true,baos,false,0.5,true) == true)> 			
					${response.reset()}
					${response.resetBuffer()}
					${response.setContentType("application/pdf")}
					${response.setHeader("Content-Disposition",  " inline; filename=document.pdf" )}
					${response.setHeader("Expires", " 0")}
					${response.setHeader("Cache-Control", " must-revalidate, post-check=0, pre-check=0" )} 
					${response.setHeader("Pragma" , "public")}      
					${baos.writeTo(response.getOutputStream())}
					${response.getOutputStream().flush()}
				<#elseif (converter.convert(imagelocation, "", 159,159,159,90,0,true,baos,false,0.5,true) == true)>        
					${response.reset()}
					${response.resetBuffer()}
					${response.setContentType("application/pdf")}
					${response.setHeader("Content-Disposition",  " inline; filename=document.pdf" )}
					${response.setHeader("Expires", " 0")}
					${response.setHeader("Cache-Control", " must-revalidate, post-check=0, pre-check=0" )} 
					${response.setHeader("Pragma" , "public")}      
					${baos.writeTo(response.getOutputStream())}
					${response.getOutputStream().flush()}
				<#else>
					<br />
					<br />
					<center><b>Image is Unavailable. Please contact Grancius Support at support@amcad.com with subject line as <i>Instrument</i> number you are trying to view.</b></center>
					<center><img title="Preview" src="<@com.currentUrlPrefix/>/blank.png"></center>
				</#if>
			<#elseif pageStyleUtil.isUserInRoleGroup('UNOFFICIAL_ROLE', request) || pageStyleUtil.isUserInRoleGroup('PER_PAGE_ROLE', request)>
				<@getUserRole request/>
				<#if isDownload?has_content && isDownload == "Y" && downloadDocument == "Y">
					<#assign downloadUrl = "/downloadDocument.admin?imagelocation=" + imagelocation + "&waterMarkStr=&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&fontSize=0&pageCount=0&isPrintingAllowed=true&isFillWatermark=false&opacity=0.5&keepOriginalPageSize=true&productkey=" + doc.get("BookName") + "_" + doc.get("Page") + "&uniqueidentifier=" + useraccesscode + "&application=AILIS">
					${request.getServletContext().getRequestDispatcher(downloadUrl).forward(request, response)}
				<#elseif isDownload?has_content && isDownload == "Y" && downloadDocument == "N">
					<#assign downloadUrl = "/viewPurchasedDocument.admin?imagelocation=" + imagelocation + "&waterMarkStr=&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&fontSize=0&pageCount=0&isPrintingAllowed=true&isFillWatermark=false&opacity=0.5&keepOriginalPageSize=true&productkey=" + doc.get("BookName") + "_" + doc.get("Page") + "&uniqueidentifier=" + useraccesscode + "&application=AILIS">
					${request.getServletContext().getRequestDispatcher(downloadUrl).forward(request, response)}				
				<#else>
					${request.setAttribute("requestImageUrl", "search.do?indexName=histindeximages&lq=ID:" + doc.get('ID'))} 
					<#assign accessImageUrl = "/viewImage.admin?imagelocation=" + imagelocation + "&waterMarkStr=UNOFFICIAL&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&productkey=" + doc.get("BookName") + "_" + doc.get("Page") + "&producttype=" + doc.get("Booktype") + "&accessname=" + useraccesscode + "&numberofpages=1&isImageAvailable=true&uniqueidentifier=" + useraccesscode + "&application=AILIS">
					${request.getServletContext().getRequestDispatcher(accessImageUrl).forward(request, response)}     
				</#if>
			</#if>
		</#foreach>
	<#else>
		<#if pageStyleUtil.isUserInRoleGroup('OFFICIAL_ROLE', request)>		
			<br />
			<br />
			<center><b>Image is Unavailable. Please contact Grancius Support at support@amcad.com with subject line as <i>Instrument</i> number you are trying to view.</b></center>
			<center><img title="Preview" src="<@com.currentUrlPrefix/>/blank.png"></center>
		<#elseif pageStyleUtil.isUserInRoleGroup('UNOFFICIAL_ROLE', request) || pageStyleUtil.isUserInRoleGroup('PER_PAGE_ROLE', request)>
			${request.setAttribute("requestImageUrl", "")} 
			<#assign imagelocation = "noimage.tif">
			<#assign accessImageUrl = "/viewImage.admin?imagelocation=" + imagelocation + "&waterMarkStr=UNOFFICIAL&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&productkey=NONE&producttype=NONE&accessname=" + useraccesscode + "&numberofpages=0&isImageAvailable=false&uniqueidentifier=" + useraccesscode + "&application=AILIS">
			${request.getServletContext().getRequestDispatcher(accessImageUrl).forward(request, response)}   
		<#else>
			<#include "denied.html">
		</#if>
	</#if>
<#else>
    <br /><br /><br />
<table align="center" border="0">
   <tr>
    <td align="center">
       This is premium content. To view images please subscribe to our premium subscription which will provide you access to images and other premium features. <br /><br />You can add the premium access using this link -- <a href="viewAvailableSubscriptions.admin">Add Subscriptions</a><br /><br />
    </td>
   </tr>
</table>
</#if>