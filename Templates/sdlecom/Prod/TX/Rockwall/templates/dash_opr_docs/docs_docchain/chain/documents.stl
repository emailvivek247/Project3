<table width="100%">
<tr>
<td width="50%" height:100%>
    <div width="100%" id="documentChain"></div>     
</td>
<td width="50%" height:100%>
    <div id="documentDetails" style="width: 100%; height: 90%; float:right"><iframe id="details" style="width: 100%; height: 900px;" frameborder="0"></iframe></div>    
</td>
</tr>
</table>

<#if searchResult.docs?has_content>
<script language="JavaScript">

    var docwidth;
    var docheight;
    if (window.innerWidth || window.innerHeight){ 
        docwidth = window.innerWidth; 
        docheight = window.innerHeight; 
    }
    
    if (document.body.clientWidth || document.body.clientHeight){ 
        docwidth = document.body.clientWidth; 
        docheight = document.body.clientHeight;
    }   

    if (docwidth < 1000){
        docwidth = 500;
    }
    else {
        docwidth = Math.round(docwidth * 0.5);
    } 
    
    if (docheight < 700){
        docheight = 500;
    }
    else {
        docheight = Math.round(docheight);
    }

    var documents = [];
    var x_cor = 30; 
    var y_cor = 30; 
    var MaxX = 100;
    var MaxY = 100; 
    
    var MinY = 10; 

    var dataset = "<dataset plotBorderAlpha='0' allowDrag='0' showformbtn='0' >";
    var connectors = "<connectors color='0E1359'>";
        var orgInstDoctype = "";
    startRetreiving();
        
    function startRetreiving(){
        var key = '${searchResult.docs[0].get("SEQKEY")}';
        documents.push(key);  
        if (x_cor < 0) x_cor = 0; if (x_cor > 100) x = MaxX;
                if (y_cor < 0) y_cor = MinY; if (y_cor > 100) y = MaxY;
        dataset = dataset + "<set x='" + x_cor + "'  y='" + y_cor + "' allowDrag='1' width='120' height='60' name='" + key + " , " + '#ORGDOCTYPEPLACEHOLDER#' +"'  color='000044' link='javaScript:loadDetails(" + key + ")' id='" + key +"' imageNode='1' imageurl='smartcharts/powerCharts/resources/doc3.png' alpha='0'  imageWidth='32' imageHeight='32' imageAlign='bottom' labelAlign='top'/>";                               
        retrieveRefDocuments(key, x_cor, y_cor);
        loadDetails(key);

    }
    
    function renderChart() {
        connectors = connectors + "</connectors>";
        dataset = dataset + "</dataset>";
        MaxX = MaxX + 30;
        MaxY = MaxY + 30;
        var chartData = "<chart showFormBtn='0' baseFontSize='12' outCnvBaseFont='000000' bgColor='ffffff' bgAlpha='80' canvasBgColor='ffffff' canvasBgAlpha='100' adjustDiv='1' caption='Document Chain for Instrument Number : " + '${searchResult.docs[0].get("SEQKEY")}' + "' showAboutMenuItem='0' palette='1' xAxisMinValue='0' enableLink='1'  is3D='1' viewMode='1' allowDrag='1'>";
        chartData = chartData  + dataset + connectors + "</chart>";
        var chart = new SmartCharts("smartcharts/powerCharts/charts/DragNode.swf", "ChartId", docheight, docwidth, "0", "0");
        chartData = chartData.replace("#ORGDOCTYPEPLACEHOLDER#", orgInstDoctype);
        chart.setDataXML(chartData);
        chart.render("documentChain");
    }
    

    function retrieveRefDocuments(seqkey, xCoord, yCoord) {
         var isNewReferences = false;
         var newDocuments = [];
         var pointX = xCoord;
         var pointY = yCoord;
         var key;
         var url = "search.do?searchType=1&indexName=docs_docchain&templateName=JSONP&q=" + seqkey + "&callback=?";
         $.ajax({                  
          url: url,  
          dataType: 'json',  
          async: false,  
          success: function(data){
                       var isOdd = false;
                       $.each(data.items, function(i,item){                           
                           isNewReferences = false;
                           if (item.REFNUM == '${searchResult.docs[0].get("SEQKEY")}') {
                              orgInstDoctype = item.DOC_TYPE.replace("<B>", "").replace("</B>","");     
                           }
                           if ((item.REFNUM.replace("<B>", "").replace("</B>","") != "" && $.inArray(item.REFNUM.replace("<B>", "").replace("</B>",""), documents) == -1) || (item.LEGACYREFNNUM.replace("<B>", "").replace("</B>","") != "" && $.inArray(item.LEGACYREFNNUM.replace("<B>", "").replace("</B>",""), documents) == -1)) {
                                   
                                   if (item.REFNUM.replace("<B>", "").replace("</B>","") != "" && $.inArray(item.REFNUM.replace("<B>", "").replace("</B>",""), documents) == -1){
                                        key = item.REFNUM.replace("<B>", "").replace("</B>","");
                                   }
                                   else if (item.LEGACYREFNNUM.replace("<B>", "").replace("</B>","") != "" && $.inArray(item.LEGACYREFNNUM.replace("<B>", "").replace("</B>",""), documents) == -1){
                                        key = item.LEGACYREFNNUM.replace("<B>", "").replace("</B>","");
                                   }                                   
                                   documents.push(key);                                    
                           newDocuments.push(key + '|' + item.DOC_TYPE.replace("<B>", "").replace("</B>",""));
                   }
                   if (item.REFNUM.replace("<B>", "").replace("</B>","") != "" || item.LEGACYREFNNUM.replace("<B>", "").replace("</B>","") != "") {
                   if (item.REFNUM.replace("<B>", "").replace("</B>","") != "") {
                    connectors = connectors + "<connector strength='2' from='" + seqkey + "' to='" + item.REFNUM.replace("<B>", "").replace("</B>","") +"' color='0E1359' arrowAtStart='0' arrowAtEnd='1'/>";
                   }
                   else if (item.REFNUM.replace("<B>", "").replace("</B>","") != "") {
                    connectors = connectors + "<connector strength='2' from='" + seqkey + "' to='" + item.LEGACYREFNNUM.replace("<B>", "").replace("</B>","") +"' color='0E1359' arrowAtStart='0' arrowAtEnd='1'/>";
                   }
                   }
               });
                       $.each(newDocuments, function(i, val) {                                
                var pointsDisp = getCoor(25, newDocuments.length, i+1).split("|");
                xDisp = parseInt(pointsDisp[0]);
                yDisp = parseInt(pointsDisp[1]);
                //MaxX = pointX + xDisp;
                //MaxY = pointY + yDisp;
                
                var xcoordinate = pointX + xDisp;
                var ycoordinate = pointY + yDisp;
                
                if (xcoordinate < 0) xcoordinate = 0; if (xcoordinate > 100) x = MaxX;
                if (ycoordinate < 0) ycoordinate = MinY; if (ycoordinate > 100) x = MaxY;
                
                        if (y_cor < 0) y_cor = 0; if (y_cor > 100) y = MaxY;
                
                dataset = dataset + "<set x='" + xcoordinate  + "'  y='" + ycoordinate + "' allowDrag='1' width='120' height='60' name='" + val.split("|")[0] + " , " + val.split("|")[1] +"'  color='000044' link='javaScript:loadDetails(" + val.split("|")[0] + ")' id='" + val.split("|")[0] +"' imageNode='1' imageurl='smartcharts/powerCharts/resources/doc3.png' alpha='0'  imageWidth='32' imageHeight='32' imageAlign='bottom' labelAlign='top'/>";               
                       });
                       $.each(newDocuments, function(i, val) {
                var pointsDisp = getCoor(25, newDocuments.length, i+1).split("|");
                xDisp = parseInt(pointsDisp[0]);
                yDisp = parseInt(pointsDisp[1]); 
                retrieveRefDocuments2(val.split("|")[0], (pointX + xDisp), (pointY + yDisp));
                       });
                       renderChart();
                  } 
         });             
    }
    
    function retrieveRefDocuments2(seqkey, xCoord, yCoord) {
         var isNewReferences = false;
         var newDocuments = [];
         var pointX = xCoord;
         var pointY = yCoord;
         var key;
         var url = "search.do?searchType=1&indexName=docs_docchain&templateName=JSONP&q=" + seqkey + "&callback=?";
         $.ajax({  
          url: url,  
          dataType: 'json',  
          async: false,  
          success: function(data){
               var isOdd = false;
               $.each(data.items, function(i,item){
               isNewReferences = false;               
           if (item.REFNUM == '${searchResult.docs[0].get("SEQKEY")}') {
                orgInstDoctype = item.DOC_TYPE.replace("<B>", "").replace("</B>","");   
           }
               if ((item.REFNUM.replace("<B>", "").replace("</B>","") != "" && $.inArray(item.REFNUM.replace("<B>", "").replace("</B>",""), documents) == -1) || (item.LEGACYREFNNUM.replace("<B>", "").replace("</B>","") != "" && $.inArray(item.LEGACYREFNNUM.replace("<B>", "").replace("</B>",""), documents) == -1)) {
                   
                   if (item.REFNUM.replace("<B>", "").replace("</B>","") != "" && $.inArray(item.REFNUM.replace("<B>", "").replace("</B>",""), documents) == -1){
                    key = item.REFNUM.replace("<B>", "").replace("</B>","");
                   }
                   else if (item.LEGACYREFNNUM.replace("<B>", "").replace("</B>","") != "" && $.inArray(item.LEGACYREFNNUM.replace("<B>", "").replace("</B>",""), documents) == -1){
                    key = item.LEGACYREFNNUM.replace("<B>", "").replace("</B>","");
                   }                   
                   documents.push(key);                                    
                   newDocuments.push(key + '|' + item.DOC_TYPE.replace("<B>", "").replace("</B>",""));
               }
               if (item.REFNUM.replace("<B>", "").replace("</B>","") != "" || item.LEGACYREFNNUM.replace("<B>", "").replace("</B>","") != "") {
                   if (item.REFNUM.replace("<B>", "").replace("</B>","") != "") {
                    connectors = connectors + "<connector strength='1' from='" + seqkey + "' to='" + item.REFNUM.replace("<B>", "").replace("</B>","") +"' color='0E1359' arrowAtStart='0' arrowAtEnd='1'/>";
                   }
                   else if (item.REFNUM.replace("<B>", "").replace("</B>","") != "") {
                    connectors = connectors + "<connector strength='1' from='" + seqkey + "' to='" + item.LEGACYREFNNUM.replace("<B>", "").replace("</B>","") +"' color='0E1359' arrowAtStart='0' arrowAtEnd='1'/>";
                   }
               }
               });
               $.each(newDocuments, function(i, val) {
                        var pointsDisp = getCoor(25, newDocuments.length, i+1).split("|");
                xDisp = parseInt(pointsDisp[0]);
            yDisp = parseInt(pointsDisp[1]);
            //MaxX = pointX + xDisp;
            //MaxY = pointY + yDisp;
            
                var xcoordinate = pointX + xDisp;
            var ycoordinate = pointY + yDisp;

            if (xcoordinate < 0) xcoordinate = 0; if (xcoordinate > 100) x = MaxX;
            if (ycoordinate < 0) ycoordinate = MinY; if (ycoordinate > 100) x = MaxY;
            
                    dataset = dataset + "<set x='" + xcoordinate  + "'  y='" + ycoordinate + "' allowDrag='1' width='120' height='60' name='" + val.split("|")[0] + " , " + val.split("|")[1] +"'  color='000044' link='javaScript:loadDetails(" + val.split("|")[0] + ")' id='" + val.split("|")[0] +"' imageNode='1' imageurl='smartcharts/powerCharts/resources/doc3.png' alpha='0'  imageWidth='32' imageHeight='32' imageAlign='bottom' labelAlign='top'/>";
               });
               $.each(newDocuments, function(i, val) {
                    var pointsDisp = getCoor(25, newDocuments.length, i+1).split("|");
                xDisp = parseInt(pointsDisp[0]);
                yDisp = parseInt(pointsDisp[1]); 
                    retrieveRefDocuments2(val.split("|")[0], (pointX + xDisp), (pointY + yDisp));
               });
          }  
         });             
    }
    
    function loadDetails(key) {
     <#-- 
                document.getElementById("details").src  = "search.do?indexName=details&templateName=details_chain&lq=Instrument:\"" + key + "\"";
              
      -->        
                document.getElementById("details").src  = "search.do?indexName=details&templateName=detailschain&lq=Instrument:\"" + key + "\"";
                                                        
                  
                
                
                
                
    }

        function getCoor(radius, points, currentPoint) {
                angle = (6.2857/points) * currentPoint;            
                x = radius * Math.cos(angle);
                y = radius * Math.sin(angle);
                return(x.toString() + "|" + y.toString() + "|" + angle.toString());
        }
</script>  
</#if>