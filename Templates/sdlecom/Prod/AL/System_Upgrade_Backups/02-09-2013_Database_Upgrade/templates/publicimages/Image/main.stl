<#if request.getServletContext().getInitParameter("isSecurityEnabled") == "false" || (request.isUserInRole('ROAM_ADMIN') || request.isUserInRole('JEFFERSON_ADMIN') || request.isUserInRole('JEFFERSON_PROBATE_ACCESS') || request.isUserInRole('JEFFERSON_PERPAGE_ACCESS') )>
<#assign isDownload = request.getParameter("isDownload") >
	<#if searchResult.docs?has_content>
		<#foreach doc in searchResult.docs>
			<#assign fileNetAdapter = new("com.fdt.sdl.adapter.FilenetAdapter")>
			<#assign byteArray = fileNetAdapter.getContent(doc.get("Instrument"))>
			<#if request.getServletContext().getInitParameter("isSecurityEnabled") == "false" || (request.isUserInRole('ROAM_ADMIN') || request.isUserInRole('JEFFERSON_ADMIN') || request.isUserInRole('JEFFERSON_PROBATE_ACCESS'))>
				<#if byteArray?has_content >
				<#assign baos = new("java.io.ByteArrayOutputStream")>
				<#assign converter = new("com.fdt.common.util.TIFFToPDFConverter")>
					<#if (converter.convert(byteArray, "", 159,159,159,0,0,true,baos,false,1) == true)>
						${response.reset()}
						${response.resetBuffer()}
						${response.setContentType("application/pdf")}
						${response.setHeader("Content-Disposition",  " inline; filename=document.pdf" )}
						${response.setHeader("Expires", " 0")}
						${response.setHeader("Cache-Control", " must-revalidate, post-check=0, pre-check=0" )} 
						${response.setHeader("Pragma" , "public")}      
						${baos.writeTo(response.getOutputStream())}
						${response.getOutputStream().flush()}
					<#else>
						<br><br><center><b>Not Able to Generate PDF</b></center>
					</#if>
				<#else>
					<br><br><center><b>Image Unavailable</b></center>
				</#if>
			<#elseif request.isUserInRole('JEFFERSON_PERPAGE_ACCESS')>							
				<#if byteArray?has_content >
					<#if isDownload?has_content && isDownload == "Y">
						<#assign downloadUrl = "/downloadDocument.admin?imagelocation=" + imagelocation + "&waterMarkStr=&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&fontSize=0&pageCount=0&isPrintingAllowed=true&isFillWaterMark=false&opacity=1&productkey=" + doc.get("Instrument") + "&uniqueidentifier=JEFFERSON_PERPAGE_ACCESS&application=AILIS">
						${request.getServletContext().getRequestDispatcher(downloadUrl).forward(request, response)}
					<#else>			
						${request.setAttribute("requestImageUrl", "search.do?indexName=publicimages&isPrintingAllowed=true&isFillWatermark=false&opacity=1&lq=Instrument:" + doc.get('Instrument'))} 
                                                <#assign accessImageUrl = "/viewImage.admin?imagelocation=dummy&waterMarkStr=UNOFFICIAL&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&productkey=" + doc.get("Instrument") + "&producttype=" + doc.get("DocTypeDesc") + "&accessname=JEFFERSON_PERPAGE_ACCESS&numberofpages=" + doc.get("PAGECOUNT") + "&isImageAvailable=true&uniqueidentifier=JEFFERSON_PERPAGE_ACCESS&application=AILIS">
						${request.getServletContext().getRequestDispatcher(accessImageUrl).forward(request, response)}     
					</#if>
				<#else>
					${request.setAttribute("requestImageUrl", "")} 
					<#assign imagelocation = "noimage.tif">
					<#assign accessImageUrl = "/viewImage.admin?imagelocation=" + imagelocation + "&waterMarkStr=UNOFFICIAL&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&productkey=NONE&producttype=NONE&accessname=JEFFERSON_PERPAGE_ACCESS&numberofpages=0&isImageAvailable=false&uniqueidentifier=JEFFERSON_PERPAGE_ACCESS&application=AILIS">
					${request.getServletContext().getRequestDispatcher(accessImageUrl).forward(request, response)}   
				</#if>
			</#if>
		</#foreach>
	<#else>
		<#if request.isUserInRole('JEFFERSON_PROBATE_ACCESS') || request.isUserInRole('JEFFERSON_ADMIN') || request.isUserInRole('ROAM_ADMIN')>		
			<br />
			<br />
			<center><b>Image is Unavailable. Please contact AMCAD Support at support@amcad.com with subject line as <i>Instrument</i> number you are trying to view.</b></center>
			<center><img title="Preview" src="<@com.currentUrlPrefix/>/blank.png"></center>
		<#elseif request.isUserInRole('JEFFERSON_PERPAGE_ACCESS')>
			${request.setAttribute("requestImageUrl", "")} 
			<#assign imagelocation = "noimage.tif">
			<#assign accessImageUrl = "/viewImage.admin?imagelocation=" + imagelocation + "&waterMarkStr=UNOFFICIAL&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&productkey=NONE&producttype=NONE&accessname=JEFFERSON_PERPAGE_ACCESS&numberofpages=0&isImageAvailable=false&uniqueidentifier=JEFFERSON_PERPAGE_ACCESS&application=AILIS">
			${request.getServletContext().getRequestDispatcher(accessImageUrl).forward(request, response)}   
		<#else>
			<#include "denied.html">
		</#if>
	</#if>
<#else>
	<br /><br /><br />
	<table align="center" border="0">
	<tr>
	<td align="center">
	This is premium content. To view images please subscribe to our premium subscription which will provide you access to images and other premium features. <br /><br />You can add the premium access using this link -- <a href="viewAvailableSubscriptions.admin">Add Subscriptions</a><br /><br />
	</td>
	</tr>
	</table>
</#if>