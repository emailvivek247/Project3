<#assign isDownload = request.getParameter("isDownload") >
<#if searchResult.docs?has_content>
	<#foreach doc in searchResult.docs>
		<#assign imagelocation = "\\\\" + doc.get("Server") + "\\" +  doc.get("Path") + "\\" + doc.get("Year") + "\\" + doc.get("Month") + "\\" + doc.get("Day") + "\\" + doc.get("ImageName")>
		<#if request.isUserInRole('DALLAS_LAND_MARR_ACCESS') || request.isUserInRole('DALLAS_ADMIN') || request.isUserInRole('DALLAS_ALL_ACCESS')>
    	                <#assign baos = new("java.io.ByteArrayOutputStream")>
			<#assign converter = new("com.fdt.common.util.TIFFToPDFConverter")>
			<#if (converter.convert(imagelocation + ".burned", "UNOFFICIAL", 159,159,159, baos) == true)> 			
				${response.reset()}
				${response.resetBuffer()}
				${response.setContentType("application/pdf")}
				${response.setHeader("Content-Disposition",  " inline; filename=document.pdf" )}
				${response.setHeader("Expires", " 0")}
				${response.setHeader("Cache-Control", " must-revalidate, post-check=0, pre-check=0" )} 
				${response.setHeader("Pragma" , "public")}      
				${baos.writeTo(response.getOutputStream())}
				${response.getOutputStream().flush()}
			<#elseif (converter.convert(imagelocation, "UNOFFICIAL", 159,159,159, baos) == true)>        
				${response.reset()}
				${response.resetBuffer()}
				${response.setContentType("application/pdf")}
				${response.setHeader("Content-Disposition",  " inline; filename=document.pdf" )}
				${response.setHeader("Expires", " 0")}
				${response.setHeader("Cache-Control", " must-revalidate, post-check=0, pre-check=0" )} 
				${response.setHeader("Pragma" , "public")}      
				${baos.writeTo(response.getOutputStream())}
				${response.getOutputStream().flush()}
			<#else>
				<br />
				<br />
				<center><b>Image is Unavailable. Please contact AMCAD Support at support@amcad.com with subject line as <i>Instrument</i> number you are trying to view.</b></center>
				<center><img title="Preview" src="<@com.currentUrlPrefix/>/blank.png"></center>
			</#if>
		<#elseif request.isUserInRole('DALLAS_PERPAGE_ACCESS')>			
				<#if isDownload?has_content && isDownload == "Y">
						<#assign downloadUrl = "/downloadDocument.admin?imagelocation=" + imagelocation + "&waterMarkStr=UNOFFICIAL&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&productkey=" + doc.get("Instrument") + "&uniqueidentifier=DALLAS_PERPAGE_ACCESS&application=AILIS">
						${request.getServletContext().getRequestDispatcher(downloadUrl).forward(request, response)}
				<#else>
						${request.setAttribute("requestImageUrl", "search.do?indexName=dallasimages&lq=Instrument:" + doc.get('Instrument'))} 
						<#assign accessImageUrl = "/viewImage.admin?imagelocation=" + imagelocation + "&waterMarkStr=UNOFFICIAL&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&productkey=" + doc.get("Instrument") + "&producttype=DEED&accessname=DALLAS_PERPAGE_ACCESS&numberofpages=3&isImageAvailable=true&uniqueidentifier=DALLAS_PERPAGE_ACCESS&application=AILIS">
						${request.getServletContext().getRequestDispatcher(accessImageUrl).forward(request, response)}     
				</#if>
		</#if>
	</#foreach>
<#else>
	${request.setAttribute("requestImageUrl", "search.do?indexName=dallasimages&lq=Instrument:")}
	<#assign accessImageUrl = "/viewImage.admin?imagelocation=&waterMarkStr=UNOFFICIAL&waterMarkRedColorCode=159&waterMarkGreenColorCode=159&waterMarkBlueColorCode=159&productkey=&producttype=&accessname=DALLAS_PERPAGE_ACCESS&numberofpages=0&isImageAvailable=true&uniqueidentifier=DALLAS_PERPAGE_ACCESS&application=AILIS">
	${request.getServletContext().getRequestDispatcher(accessImageUrl).forward(request, response)} 
</#if>